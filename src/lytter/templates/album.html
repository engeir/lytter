{% extends "base.html" %}

{% block title %}{{ album_name }} - {{ artist_name }} - Last.fm Stats{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="/artist/{{ artist_name|urlencode }}">{{ artist_name }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ album_name }}</li>
    </ol>
</nav>

<h1 class="mb-2">{{ album_name }}</h1>
<h5 class="text-muted mb-4">by {{ artist_name }}</h5>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Total Plays</h5>
                <h3 class="text-primary">{{ "{:,}".format(total_plays) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Unique Tracks</h5>
                <h3 class="text-primary">{{ unique_tracks }}</h3>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Listening History</h5>
                <div id="history-chart" style="min-height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Album Tracks</h5>
                <div id="tracks-list"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const historyData = {{ history_chart|safe }};
    const artistName = {{ artist_name|tojson }};
    const albumName = {{ album_name|tojson }};

    // Plot listening history
    Plotly.newPlot('history-chart', historyData.data, historyData.layout);

    // Fetch and display tracks from this album
    fetch(`/album-tracks?artist=${encodeURIComponent(artistName)}&album=${encodeURIComponent(albumName)}`)
        .then(response => response.json())
        .then(data => {
            const albumTracks = data.tracks;
            const maxPlays = albumTracks.length > 0 ? albumTracks[0].plays : 1;

            const list = albumTracks.slice(0, 50).map(song => {
                const maxWidthPercent = 100;
                const barWidth = (song.plays / maxPlays) * maxWidthPercent;

                return `<div class="d-flex justify-content-between align-items-center py-3 position-relative" style="border-bottom: 1px solid rgba(240, 246, 252, 0.1);">
                    <a href="/song/${encodeURIComponent(artistName)}/${encodeURIComponent(song.track)}" class="flex-grow-1 me-3 text-decoration-none" style="color: #f0f6fc; max-width: 40%; font-size: 0.95rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${song.track}
                    </a>
                    <div class="d-flex align-items-center flex-grow-1" style="max-width: 60%; justify-content: flex-end;">
                        <div style="
                            width: ${barWidth}%;
                            height: 32px;
                            background: linear-gradient(90deg, rgba(56, 139, 253, 0.3) 0%, rgba(56, 139, 253, 0.8) 100%);
                            border-radius: 0.375rem 0 0 0.375rem;
                        "></div>
                        <span style="
                            background: linear-gradient(135deg, #58a6ff 0%, #388bfd 100%);
                            color: #0d1117;
                            font-weight: 600;
                            font-size: 0.9rem;
                            padding: 0.5rem 0.75rem;
                            border-radius: 0 0.375rem 0.375rem 0;
                            min-width: 70px;
                            text-align: center;
                            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                        ">${song.plays.toLocaleString()}</span>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('tracks-list').innerHTML = list;
        })
        .catch(error => {
            document.getElementById('tracks-list').innerHTML = '<p class="text-muted">Error loading tracks</p>';
        });
</script>
{% endblock %}
