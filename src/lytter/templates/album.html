{% extends "base.html" %}
{% from 'macros.html' import stat_card %}

{% block title %}{{ album_name }} - {{ artist_name }} - Last.fm Stats{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="/artist/{{ artist_name|urlencode }}">{{ artist_name }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ album_name }}</li>
    </ol>
</nav>

<h1 class="mb-2">{{ album_name }}</h1>
<h5 class="text-muted mb-4">by {{ artist_name }}</h5>

<div class="row mb-4">
    <div class="col-md-6">
        {{ stat_card("Total Plays", total_plays) }}
    </div>
    <div class="col-md-6">
        {{ stat_card("Unique Tracks", unique_tracks) }}
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Listening History</h5>
                <div id="history-chart" style="min-height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Album Tracks</h5>
                <div id="tracks-list"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const historyData = {{ history_chart|safe }};
    const artistName = {{ artist_name|tojson }};
    const albumName = {{ album_name|tojson }};

    // Plot listening history
    Plotly.newPlot('history-chart', historyData.data, historyData.layout);

    // Fetch and display tracks from this album
    fetch(`/album-tracks?artist=${encodeURIComponent(artistName)}&album=${encodeURIComponent(albumName)}`)
        .then(response => response.json())
        .then(data => {
            const maxPlays = data.tracks.length > 0 ? data.tracks[0].plays : 1;
            const list = data.tracks.slice(0, 50).map(song => {
                const barWidth = (song.plays / maxPlays) * 100;
                return `<div class="bar-chart-item">
                    <a href="/song/${encodeURIComponent(artistName)}/${encodeURIComponent(song.track)}" class="bar-chart-item-link">${song.track}</a>
                    <div class="bar-chart-visual">
                        <div class="bar-chart-bar" style="width: ${barWidth}%;"></div>
                        <span class="bar-chart-value">${song.plays.toLocaleString()}</span>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('tracks-list').innerHTML = list;
        })
        .catch(error => {
            document.getElementById('tracks-list').innerHTML = '<p class="text-muted">Error loading tracks</p>';
        });
</script>
{% endblock %}
