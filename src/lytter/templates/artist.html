{% extends "base.html" %}
{% from 'macros.html' import stat_card %}

{% block title %}{{ artist_name }} - Last.fm Stats{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ artist_name }}</li>
    </ol>
</nav>

<h1 class="mb-4">{{ artist_name }}</h1>

<div class="row mb-4">
    <div class="col-md-4">
        {{ stat_card("Total Plays", total_plays) }}
    </div>
    <div class="col-md-4">
        {{ stat_card("Unique Tracks", unique_tracks) }}
    </div>
    <div class="col-md-4">
        {{ stat_card("Unique Albums", unique_albums) }}
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Listening History</h5>
                <div id="history-chart" style="min-height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Top Songs</h5>
                <div id="top-songs-list"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Top Albums</h5>
                <div id="top-albums-list"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const historyData = {{ history_chart|safe }};
    const artistName = {{ artist_name|tojson }};

    // Plot listening history
    Plotly.newPlot('history-chart', historyData.data, historyData.layout);

    // Fetch and display top songs  
    fetch(`/artist-top-songs?artist=${encodeURIComponent(artistName)}`)
        .then(response => response.json())
        .then(data => {
            const maxPlays = data.songs.length > 0 ? data.songs[0].plays : 1;
            const list = data.songs.map(song => {
                const barWidth = (song.plays / maxPlays) * 100;
                return `<div class="bar-chart-item">
                    <a href="/song/${encodeURIComponent(artistName)}/${encodeURIComponent(song.track)}" class="bar-chart-item-link">${song.track}</a>
                    <div class="bar-chart-visual">
                        <div class="bar-chart-bar" style="width: ${barWidth}%;"></div>
                        <span class="bar-chart-value">${song.plays.toLocaleString()}</span>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('top-songs-list').innerHTML = list;
        })
        .catch(error => {
            document.getElementById('top-songs-list').innerHTML = '<p class="text-muted">Error loading songs</p>';
        });

    // Fetch and display top albums
    fetch(`/artist-top-albums?artist=${encodeURIComponent(artistName)}`)
        .then(response => response.json())
        .then(data => {
            const maxPlays = data.albums.length > 0 ? data.albums[0].plays : 1;
            const list = data.albums.map(album => {
                const barWidth = (album.plays / maxPlays) * 100;
                return `<div class="bar-chart-item">
                    <a href="/album/${encodeURIComponent(artistName)}/${encodeURIComponent(album.album)}" class="bar-chart-item-link">${album.album}</a>
                    <div class="bar-chart-visual">
                        <div class="bar-chart-bar" style="width: ${barWidth}%;"></div>
                        <span class="bar-chart-value">${album.plays.toLocaleString()}</span>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('top-albums-list').innerHTML = list;
        })
        .catch(error => {
            document.getElementById('top-albums-list').innerHTML = '<p class="text-muted">Error loading albums</p>';
        });
</script>
{% endblock %}
