{% extends "base.html" %}

{% block title %}{{ artist_name }} - Last.fm Stats{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ artist_name }}</li>
    </ol>
</nav>

<h1 class="mb-4">{{ artist_name }}</h1>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Total Plays</h5>
                <h3 class="text-primary">{{ "{:,}".format(total_plays) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Unique Tracks</h5>
                <h3 class="text-primary">{{ unique_tracks }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Unique Albums</h5>
                <h3 class="text-primary">{{ unique_albums }}</h3>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Listening History</h5>
                <div id="history-chart" style="min-height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Top Songs</h5>
                <div id="top-songs-list"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Top Albums</h5>
                <div id="top-albums-list"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const historyData = {{ history_chart|safe }};
    const artistName = "{{ artist_name }}";

    // Plot listening history
    Plotly.newPlot('history-chart', historyData.data, historyData.layout);

    // Fetch and display top songs
    fetch(`/artist-top-songs?artist=${encodeURIComponent(artistName)}`)
        .then(response => response.json())
        .then(data => {
            const maxPlays = data.songs.length > 0 ? data.songs[0].plays : 1;

            const list = data.songs.map(song => {
                const maxWidthPercent = 100;
                const barWidth = (song.plays / maxPlays) * maxWidthPercent;

                return `<div class="d-flex justify-content-between align-items-center py-3 position-relative" style="border-bottom: 1px solid rgba(240, 246, 252, 0.1);">
                    <span class="flex-grow-1 me-3" style="color: #f0f6fc; max-width: 40%; font-size: 0.95rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${song.track}</span>
                    <div class="d-flex align-items-center flex-grow-1" style="max-width: 60%; justify-content: flex-end;">
                        <div style="
                            width: ${barWidth}%;
                            height: 32px;
                            background: linear-gradient(90deg, rgba(56, 139, 253, 0.3) 0%, rgba(56, 139, 253, 0.8) 100%);
                            border-radius: 0.375rem 0 0 0.375rem;
                        "></div>
                        <span style="
                            background: linear-gradient(135deg, #58a6ff 0%, #388bfd 100%);
                            color: #0d1117;
                            font-weight: 600;
                            font-size: 0.9rem;
                            padding: 0.5rem 0.75rem;
                            border-radius: 0 0.375rem 0.375rem 0;
                            min-width: 70px;
                            text-align: center;
                            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                        ">${song.plays.toLocaleString()}</span>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('top-songs-list').innerHTML = list;
        })
        .catch(error => {
            document.getElementById('top-songs-list').innerHTML = '<p class="text-muted">Error loading songs</p>';
        });

    // Fetch and display top albums
    fetch(`/artist-top-albums?artist=${encodeURIComponent(artistName)}`)
        .then(response => response.json())
        .then(data => {
            const maxPlays = data.albums.length > 0 ? data.albums[0].plays : 1;

            const list = data.albums.map(album => {
                const maxWidthPercent = 100;
                const barWidth = (album.plays / maxPlays) * maxWidthPercent;

                return `<div class="d-flex justify-content-between align-items-center py-3 position-relative" style="border-bottom: 1px solid rgba(240, 246, 252, 0.1);">
                    <span class="flex-grow-1 me-3" style="color: #f0f6fc; max-width: 40%; font-size: 0.95rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${album.album}</span>
                    <div class="d-flex align-items-center flex-grow-1" style="max-width: 60%; justify-content: flex-end;">
                        <div style="
                            width: ${barWidth}%;
                            height: 32px;
                            background: linear-gradient(90deg, rgba(56, 139, 253, 0.3) 0%, rgba(56, 139, 253, 0.8) 100%);
                            border-radius: 0.375rem 0 0 0.375rem;
                        "></div>
                        <span style="
                            background: linear-gradient(135deg, #58a6ff 0%, #388bfd 100%);
                            color: #0d1117;
                            font-weight: 600;
                            font-size: 0.9rem;
                            padding: 0.5rem 0.75rem;
                            border-radius: 0 0.375rem 0.375rem 0;
                            min-width: 70px;
                            text-align: center;
                            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                        ">${album.plays.toLocaleString()}</span>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('top-albums-list').innerHTML = list;
        })
        .catch(error => {
            document.getElementById('top-albums-list').innerHTML = '<p class="text-muted">Error loading albums</p>';
        });
</script>
{% endblock %}
