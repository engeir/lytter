{% extends "base.html" %}
{% block title %}
  Yearly Statistics - Last.fm Stats
{% endblock
%}

{% block content %}
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="mb-4">üìä Yearly Statistics</h1>

      <!-- Year Selector -->
      <div class="card mb-4">
        <div class="card-body">
          <label for="yearSelect" class="form-label">Select Year</label>
          <select class="form-select" id="yearSelect" style="max-width: 200px">
            {% for year in years %}
              <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Time Patterns Row -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">üïê Listening by Hour</h5>
          <div id="hourly-chart" style="height: 400px"></div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">üìÖ Listening by Day of Week</h5>
          <div id="weekly-chart" style="height: 400px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Items Row -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">üéµ Top 20 Songs</h5>
          <div id="top-songs-list"
               style="max-height: 600px;
                      overflow-y: auto"
               hx-get="/html/yearly/top-items/songs?year={{ current_year }}&limit=20"
               hx-trigger="load"
               hx-swap="innerHTML">
            <div class="d-flex justify-content-center align-items-center" style="min-height: 100px">
              <div class="loading-spinner"></div>
              <span class="text-muted">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">üíø Top 20 Albums</h5>
          <div id="top-albums-list"
               style="max-height: 600px;
                      overflow-y: auto"
               hx-get="/html/yearly/top-items/albums?year={{ current_year }}&limit=20"
               hx-trigger="load"
               hx-swap="innerHTML">
            <div class="d-flex justify-content-center align-items-center" style="min-height: 100px">
              <div class="loading-spinner"></div>
              <span class="text-muted">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">üé§ Top 20 Artists</h5>
          <div id="top-artists-list"
               style="max-height: 600px;
                      overflow-y: auto"
               hx-get="/html/yearly/top-items/artists?year={{ current_year }}&limit=20"
               hx-trigger="load"
               hx-swap="innerHTML">
            <div class="d-flex justify-content-center align-items-center" style="min-height: 100px">
              <div class="loading-spinner"></div>
              <span class="text-muted">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Evolution Charts Row -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">üìà Monthly Top 3 Ranking Evolution</h5>

          <!-- Tab selector for evolution type -->
          <ul class="nav nav-tabs mb-3" id="evolutionTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active"
                      id="artists-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#artists-evolution"
                      type="button"
                      role="tab">Artists</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="albums-tab" data-bs-toggle="tab" data-bs-target="#albums-evolution" type="button" role="tab">
                Albums
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="songs-tab" data-bs-toggle="tab" data-bs-target="#songs-evolution" type="button" role="tab">
                Songs
              </button>
            </li>
          </ul>

          <div class="tab-content" id="evolutionTabContent">
            <div class="tab-pane fade show active" id="artists-evolution" role="tabpanel">
              <div id="artists-evolution-chart" style="height: 600px"></div>
            </div>
            <div class="tab-pane fade" id="albums-evolution" role="tabpanel">
              <div id="albums-evolution-chart" style="height: 600px"></div>
            </div>
            <div class="tab-pane fade" id="songs-evolution" role="tabpanel">
              <div id="songs-evolution-chart" style="height: 600px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script>
      let currentYear = {{ current_year }};

      // Update all stats when year changes
      document.getElementById('yearSelect').addEventListener('change', function() {
          currentYear = parseInt(this.value);
          
          console.log('Year changed to:', currentYear);

          // Fetch URLs
          const songUrl = `/html/yearly/top-items/songs?year=${currentYear}&limit=20`;
          const albumUrl = `/html/yearly/top-items/albums?year=${currentYear}&limit=20`;
          const artistUrl = `/html/yearly/top-items/artists?year=${currentYear}&limit=20`;
          
          // Use HTMX for songs and artists
          console.log('Fetching songs:', songUrl);
          htmx.ajax('GET', songUrl, { target: '#top-songs-list', swap: 'innerHTML' });
          
          console.log('Fetching artists:', artistUrl);
          htmx.ajax('GET', artistUrl, { target: '#top-artists-list', swap: 'innerHTML' });
          
          // Use plain fetch for albums to bypass HTMX issue
          console.log('Fetching albums (fetch):', albumUrl);
          fetch(albumUrl)
              .then(response => response.text())
              .then(html => {
                  document.getElementById('top-albums-list').innerHTML = html;
                  console.log('Albums updated successfully');
              })
              .catch(error => console.error('Error fetching albums:', error));

          // Load charts
          loadTimePatterns();
          loadEvolution();
      });

      function loadEvolution() {
          loadEvolutionForType('artists');
          loadEvolutionForType('albums');
          loadEvolutionForType('songs');
      }

      function loadEvolutionForType(itemType) {
          fetch(`/api/yearly/evolution?year=${currentYear}&item_type=${itemType}&top_n=3`)
              .then(response => response.json())
              .then(data => {
                  renderEvolutionChart(data, itemType);
              })
              .catch(error => console.error(`Error loading ${itemType} evolution:`, error));
      }

      function renderEvolutionChart(data, itemType) {
          if (!data.dates || data.dates.length === 0) {
              return;
          }

          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
              'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
          ];

          // Calculate rankings for each month (1 = most plays, 10 = least plays)
          const rankings = {};

          // For each month, rank all items by their play count
          for (let monthIdx = 0; monthIdx < 12; monthIdx++) {
              const monthScores = data.items.map(item => ({
                  item: item,
                  plays: data.data[item][monthIdx]
              }));

              // Sort by plays (descending) and assign ranks
              monthScores.sort((a, b) => b.plays - a.plays);

              monthScores.forEach((score, rank) => {
                  if (!rankings[score.item]) {
                      rankings[score.item] = [];
                  }
                  rankings[score.item].push({
                      rank: rank + 1, // 1-based ranking
                      plays: score.plays
                  });
              });
          }

          // Bright distinct colors for lines
          const colors = [
              '#58a6ff', '#ff6b6b', '#4ecdc4', '#ffd93d', '#ff9ff3',
              '#a8e6cf', '#ffaaa5', '#b4a7d6', '#fdcb6e', '#95e1d3'
          ];

          const traces = data.items.map((item, index) => {
              const itemRankings = rankings[item];
              const displayName = item.length > 30 ? item.substring(0, 27) + '...' : item;

              // Create hover text with plays
              const hoverText = itemRankings.map((r, monthIdx) =>
                  `${monthNames[monthIdx]}<br>Rank: #${r.rank}<br>Plays: ${r.plays}`
              );

              return {
                  x: monthNames,
                  y: itemRankings.map(r => r.rank),
                  name: displayName,
                  type: 'scatter',
                  mode: 'lines+markers',
                  line: {
                      color: colors[index % colors.length],
                      width: 3
                  },
                  marker: {
                      size: 8,
                      color: colors[index % colors.length],
                      line: {
                          color: '#161b22',
                          width: 2
                      }
                  },
                  hovertext: hoverText,
                  hoverinfo: 'text'
              };
          });

          const layout = {
              paper_bgcolor: '#161b22',
              plot_bgcolor: '#161b22',
              font: {
                  color: '#f0f6fc',
                  size: 12
              },
              xaxis: {
                  gridcolor: '#30363d',
                  color: '#f0f6fc',
                  title: 'Month'
              },
              yaxis: {
                  gridcolor: '#30363d',
                  color: '#f0f6fc',
                  title: 'Ranking',
                  autorange: false, // Manual range control
                  tickmode: 'linear',
                  tick0: 1,
                  dtick: 1,
                  range: [15.5, 0.5] // Reversed: show ranks 1-15 (higher rank number at bottom)
              },
              hovermode: 'closest',
              showlegend: true,
              legend: {
                  orientation: 'v',
                  x: 1.02,
                  y: 1,
                  xanchor: 'left',
                  yanchor: 'top',
                  bgcolor: 'rgba(22, 27, 34, 0.9)',
                  bordercolor: '#30363d',
                  borderwidth: 1,
                  font: {
                      size: 10,
                      color: '#f0f6fc'
                  }
              },
              margin: {
                  l: 80,
                  r: 200,
                  t: 20,
                  b: 60
              }
          };

          const chartId = `${itemType}-evolution-chart`;
          const config = {
              responsive: true,
              displayModeBar: false
          };

          Plotly.newPlot(chartId, traces, layout, config);

          // Add hover highlighting: brighten hovered line, fade others
          const chartElement = document.getElementById(chartId);

          chartElement.on('plotly_hover', function(eventData) {
              const hoveredIndex = eventData.points[0].curveNumber;

              // Create update object to modify all traces
              const update = {
                  'line.width': [],
                  'line.color': [],
                  'marker.size': [],
                  opacity: []
              };

              traces.forEach((trace, index) => {
                  if (index === hoveredIndex) {
                      // Highlight the hovered line
                      update['line.width'].push(5);
                      update['line.color'].push(colors[index % colors.length]);
                      update['marker.size'].push(12);
                      update.opacity.push(1);
                  } else {
                      // Fade other lines
                      update['line.width'].push(2);
                      update['line.color'].push(colors[index % colors.length]);
                      update['marker.size'].push(6);
                      update.opacity.push(0.3);
                  }
              });

              Plotly.restyle(chartId, update);
          });

          chartElement.on('plotly_unhover', function() {
              // Reset all traces to default styling
              const update = {
                  'line.width': traces.map(() => 3),
                  'line.color': traces.map((t, i) => colors[i % colors.length]),
                  'marker.size': traces.map(() => 8),
                  opacity: traces.map(() => 1)
              };

              Plotly.restyle(chartId, update);
          });

          // Add legend click/hover highlighting
          chartElement.on('plotly_legendclick', function(eventData) {
              // Prevent default toggle behavior
              return false;
          });

          chartElement.on('plotly_legenddoubleclick', function(eventData) {
              // Prevent default isolate behavior
              return false;
          });

          // Add legend hover effect using CSS approach
          // We'll attach hover listeners to the legend items after a short delay
          setTimeout(() => {
              const legendItems = chartElement.querySelectorAll('.legend .traces .legendtoggle');

              legendItems.forEach((item, index) => {
                  item.addEventListener('mouseenter', function() {
                      const update = {
                          'line.width': [],
                          'line.color': [],
                          'marker.size': [],
                          opacity: []
                      };

                      traces.forEach((trace, traceIndex) => {
                          if (traceIndex === index) {
                              // Highlight the hovered legend's line
                              update['line.width'].push(5);
                              update['line.color'].push(colors[traceIndex % colors.length]);
                              update['marker.size'].push(12);
                              update.opacity.push(1);
                          } else {
                              // Fade other lines
                              update['line.width'].push(2);
                              update['line.color'].push(colors[traceIndex % colors.length]);
                              update['marker.size'].push(6);
                              update.opacity.push(0.3);
                          }
                      });

                      Plotly.restyle(chartId, update);
                  });

                  item.addEventListener('mouseleave', function() {
                      // Reset all traces to default styling
                      const update = {
                          'line.width': traces.map(() => 3),
                          'line.color': traces.map((t, i) => colors[i % colors.length]),
                          'marker.size': traces.map(() => 8),
                          opacity: traces.map(() => 1)
                      };

                      Plotly.restyle(chartId, update);
                  });
              });
          }, 100);
      }

      function loadTimePatterns() {
          fetch(`/api/yearly/time-patterns?year=${currentYear}`)
              .then(response => response.json())
              .then(data => {
                  renderHourlyChart(data.hourly);
                  renderWeeklyChart(data.weekly, data.day_names);
              })
              .catch(error => console.error('Error loading time patterns:', error));
      }

      function renderHourlyChart(hourlyData) {
          const hours = Array.from({
              length: 24
          }, (_, i) => `${i}:00`);

          const trace = {
              type: 'barpolar',
              r: hourlyData,
              theta: hours,
              marker: {
                  color: hourlyData,
                  colorscale: 'Blues',
                  line: {
                      color: '#58a6ff',
                      width: 1
                  }
              },
              hovertemplate: '<b>%{theta}</b><br>Scrobbles: %{r}<extra></extra>'
          };

          const layout = {
              polar: {
                  radialaxis: {
                      gridcolor: '#30363d',
                      color: '#f0f6fc'
                  },
                  angularaxis: {
                      gridcolor: '#30363d',
                      color: '#f0f6fc',
                      direction: 'clockwise'
                  },
                  bgcolor: '#161b22'
              },
              paper_bgcolor: '#161b22',
              font: {
                  color: '#f0f6fc'
              },
              showlegend: false,
              margin: {
                  l: 80,
                  r: 80,
                  t: 20,
                  b: 80
              }
          };

          Plotly.newPlot('hourly-chart', [trace], layout, {
              responsive: true
          });
      }

      function renderWeeklyChart(weeklyData, dayNames) {
          const trace = {
              type: 'bar',
              x: dayNames,
              y: weeklyData,
              marker: {
                  color: '#58a6ff',
                  line: {
                      color: '#388bfd',
                      width: 1
                  }
              },
              hovertemplate: '<b>%{x}</b><br>Scrobbles: %{y}<extra></extra>'
          };

          const layout = {
              paper_bgcolor: '#161b22',
              plot_bgcolor: '#161b22',
              font: {
                  color: '#f0f6fc'
              },
              xaxis: {
                  gridcolor: '#30363d',
                  color: '#f0f6fc'
              },
              yaxis: {
                  gridcolor: '#30363d',
                  color: '#f0f6fc',
                  title: 'Scrobbles'
              },
              margin: {
                  l: 60,
                  r: 40,
                  t: 20,
                  b: 80
              }
          };

          Plotly.newPlot('weekly-chart', [trace], layout, {
              responsive: true
          });
      }

      // Load initial chart data (top lists loaded via HTMX)
      loadTimePatterns();
      loadEvolution();

      // Resize charts when tabs are switched to ensure proper width
      document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(button => {
          button.addEventListener('shown.bs.tab', function(event) {
              const target = event.target.getAttribute('data-bs-target');
              const chartId = target.replace('-evolution', '-evolution-chart').substring(1);
              setTimeout(() => {
                  Plotly.Plots.resize(chartId);
              }, 10);
          });
      });
  </script>
{% endblock %}
